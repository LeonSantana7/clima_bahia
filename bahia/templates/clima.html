<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Clima — Cidades da Bahia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <style>
      body {
        background: #f7f7f7;
      }
      .fade-up {
        animation: fadeUp 0.4s ease;
      }
      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }
      .temp {
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="mb-3 text-center">Clima — Cidades da Bahia</h1>
      <p class="text-center text-muted">
        Atualizado: <span id="last-update">carregando…</span>
      </p>
      <div class="table-responsive">
        <table
          class="table table-striped table-bordered align-middle text-center bg-white shadow-sm"
        >
          <thead class="table-dark">
            <tr>
              <th class="text-start">Cidade</th>
              <th>Temperatura</th>
              <th>Condição</th>
              <th>Umidade</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <script>
      async function atualizarTabela() {
        try {
          const response = await fetch("/api/clima/");
          if (!response.ok) return; // Sai se a API falhar

          const data = await response.json();
          const tbody = document.querySelector("#tbody");

          // Limpa a tabela antes de adicionar novas linhas
          tbody.innerHTML = "";

          // Cria uma linha para cada item recebido da API
          data.itens.forEach((item) => {
            const linha = document.createElement("tr");
            linha.className = "fade-up";
            linha.innerHTML = `
              <td class="text-start">${item.cidade}</td>
              <td class="temp">${item.temp}°C</td>
              <td>
                <img alt="${item.descricao}" width="34" height="34"
                     src="https://openweathermap.org/img/wn/${item.icone}@2x.png" />
                <span class="ms-2">${item.descricao}</span>
              </td>
              <td>${item.umidade}%</td>
            `;
            tbody.appendChild(linha);
          });

          // Atualiza o horário da última verificação
          document.getElementById("last-update").textContent = new Date(
            data.atualizado_em
          ).toLocaleTimeString("pt-BR");
        } catch (error) {
          console.error("Falha ao atualizar dados:", error);
        }
      }

      // Roda a função quando a página carrega
      window.addEventListener("load", atualizarTabela);

      // E depois repete a cada 60 segundos
      setInterval(atualizarTabela, 60000);
    </script>
  </body>
</html>
